services:
  server:
    environment:
      - ICEBERG_REST__SECRET_BACKEND=kv2
      - ICEBERG_REST__VAULT={url="http://hvault:1234", user="test", password="test", secret_mount="secret"}
    depends_on:
      hvault:
        condition: service_healthy
  hvault:
    image: hashicorp/vault:latest
    ports:
      - 1234:1234
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=myroot
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:1234
    cap_add:
      - IPC_LOCK
    healthcheck:
      test: [ "CMD", "vault", "status", "-address http://localhost:1234" ]
      interval: 1s
      timeout: 10s
      retries: 3
  inithvault:
    image: hashicorp/vault:latest
    depends_on:
      hvault:
        condition: service_healthy
    restart: "no"
    entrypoint: [ "sh", "/init_vault.sh" ]
    volumes:
      - ../examples/init_vault.sh:/init_vault.sh
